<html>

<head>
    <title>RPS-web</title>
    <style type="text/css">
        /* style for headline */
        h1 {
            text-align: center;
        }
        body {
            text-align: center;
            background-color: #DFEBF1;
        }

        /* style for modal */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            text-align: left;
            /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 70%;
            /* Could be more or less, depending on screen size */
        }

        /* The Close Button */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        

        /* action for hover, or focus */
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* style for table containing the room list */
        table.roomlist {
            border: 1px solid black;
            text-align: center;
        }

        /* dedault style of td */
        td {
            border: 1px solid black;
        }

        /* default style of th */
        th {
            border: 1px solid black;
        }

        /* style for containing selection of user chosen activities */
        td.n {
            border: none;
            color: rgb(61, 25, 223);
        }

        /* style for containing selection of user chosen activities */
        th.n {
            border: none;
            color: rgb(61, 25, 223);
        }

        /* style for link to the main lobby */
        a.t {
            text-decoration-line: none;
            color: rgb(3, 3, 3);
            font-size: 50px;
        }

        /* style for top part of the document */
        div.top {
            width: 100%;
            /* style for text */
            border-bottom-style: solid;
            border-bottom-width: 4px;
            border-bottom-color: rgb(210, 156, 226);
            text-shadow: 2px 2px 2px rgb(71, 109, 214);

        }

        /* Division containing the whole document */
        div.default {
            margin: auto;
            display: inline-block;
            text-align: left;
        }

        /* style for the bottom left part of the document */
        div.left {
            float: left;
            width: 360px;
            min-height: 500px;
        }

        /* style for the center bottom part of the document */
        div.center {
            float: left;
            width: 300px;
            min-height: 300px;
        }

        /* style for the right bottom part of the document */
        div.right {
            float: left;
            width: 360px;
        }

        /* style for dividing divided part again */
        div.inner {
            width: 100%;
            float: left;
        }

        /* style for dividing divided part again */
        div.lgout {
            width: 100%;
            float: right;
            text-align: center;
        }

        /* style for the buttons */
        button {
            border-radius: 5px;
            margin-right: -4px;
            border: 1px solid rgb(235, 135, 230);
            background-color: rgba(212, 209, 211, 0);
            color: rgb(58, 61, 219);
            box-shadow: 1px 1px 1px black; 
            padding: 5px;
        }
        /* style of button when mouse is over it */
        button:hover {
            border-radius: 5px;
            margin-right: -4px;
            border: 1px solid rgb(235, 135, 230);
            background-color: rgba(106, 190, 223, 0.479);
            color: rgb(58, 61, 219);
            padding: 5px;
        }
        /* style of button when it is clicked */
        button:active {
            margin-left: 0.5%;
            margin-bottom: 0.5%;
            box-shadow: none;
        }
        
        /* style for default link */
        a {
            text-decoration-line: none;
            color: rgb(0, 22, 223);
        }
    </style>
</head>

<body>
    <!-- divide for the top of the document -->
    <div class="top">
        <h1><a class="t" href="/lobby">RPS-web Lobby</a></h1>
    </div>
    <!-- the whole document -->
    <div class="default">
        
        <!-- divide for the left part of the document -->
        <div class="left">
            <!-- divide again -->
            <div class="inner">
                <table style="width: 200px; ">
                    <!-- table for link to making room, refreshing user data -->
                    <tr class="n">
                        <!-- creating new room when user presses button -->
                        <th class="n">Create New Room</th>
                        <th class="n"><button> <a href="/newroom"><img
                                        src="https://cdn-icons.flaticon.com/png/512/3329/premium/3329465.png?token=exp=1639497727~hmac=84931e0d5c1001acfea3b7d9115d032d"
                                        style="height: 20px;"></a><br></button></th>
                    </tr>
                    <!-- refreshing list of room when user input data -->
                    <tr class="n">
                        <th class="n">Refresh Room List</th>
                        <th class="n"> <button onclick="socket.emit('lobby:reqRoomList');"><img src="https://cdn-icons-png.flaticon.com/512/740/740819.png" style="height: 20px;"></button></th>
                    </tr>
                </table>
            </div>
            <!-- divide again inside left division -->
            <div class="inner">
                <!-- table containing list of room -->
                <table id="roomlist" style="width: 360px;">
                    <th>Room Name</th>
                    <th>Max</th>
                    <th>Current</th>
                    <th>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                </table>

            </div>
        </div>

        <!-- divide for the centeral part -->
        <div class="center">
            <table style="width: 200px; margin-right:auto;">

                <!-- when button is clicked, user list is updated -->
                <tr class="n">
                    <th class="n">Refresh User List</th>
                    <th class="n"> <button onclick="socket.emit('lobby:reqUserList');"><img src="https://cdn-icons-png.flaticon.com/512/740/740819.png" style="height: 20px;"></button></th>
                </tr>
            </table>

            <ul id="userlist">
            </ul>
        </div>

        <!-- divide class for the right part -->
        <div class="right">
            <!-- divide again inside right side -->
            <div class="inner">
                <!-- text area for chatting with other users -->
                <textarea id="chatArea" onfocus="javascript:blur();"
                    style="width: 98%; height: 500px; cursor: default; "></textarea>
                    <!-- chatting input -->
                <form id="chatForm">
                    <input id="chatInput" autocomplete="off" type="text" style="width: 87%" required>
                    <button type="submit">Send</button>
                </form>
            </div>
            <!-- divide for logging out -->
            <div class="lgout">
                <a href="/logout"><img src="https://icon-library.com/images/free-logout-icon/free-logout-icon-7.jpg" style="height: 50px;"></a>
            </div>

        </div>

        
    </div>

    <!-- The Modal -->
    <div id="myModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="userdata">

            </div>
        </div>
    </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var inputname = "<%= username %>";
        var socket = io('/lobby');
        socket.emit('lobby:reqRoomList');
        socket.emit('lobby:reqUserList');

        var chatForm = document.getElementById('chatForm');
        var whisperForm = document.getElementById('whisperForm');

        var modal = document.getElementById('myModal');

        // Get the <span> element that closes the modal
        var modalspan = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        modalspan.onclick = function () {
            modal.style.display = "none";
            var userData = document.getElementById('userdata');
            userData.innerHTML = '';
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
                var userData = document.getElementById('userdata');
                userData.innerHTML = '';
            }
        }

        function getUserData(username) {
            modal.style.display = "block";
            console.log(username);
            socket.emit('lobby:reqUserData', username);
        }

        function whisper(username) {
            modal.style.display = "none";
            var userData = document.getElementById('userdata');
            userData.innerHTML = '';
            var chatInput = document.getElementById('chatInput');
            chatInput.value = username + '$$:';
        }

        function closeModal() {
            modal.style.display = "none";
            var userData = document.getElementById('userdata');
            userData.innerHTML = '';
        }


        socket.on('lobby:emitChat', (msg, username) => {
            var chatArea = document.getElementById('chatArea');
            chatArea.append("\n" + username + " : " + msg);
        });

        socket.on('lobby:resRoomList', (data) => {
            var roomList = document.getElementById('roomlist');
            roomList.innerHTML = `
                <th>Room Name</th>
                <th>Max</th>
                <th>Current</th>
                <th>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
            `;
            data.forEach((elem) => {
                if(!elem.started) {
                    roomList.innerHTML += '<tr>'
                    roomList.innerHTML += `
                        <td>${elem.name}</td>
                        <td>${elem.max_player_count}</td>
                        <td>${elem.players.length}</td>
                        <td><a href="/game/${elem.name}">Join</a></td>
                    `;
                    roomList.innerHTML += '</tr>';
                }
            })
        });

        socket.on('lobby:resUserList', (data) => {
            var userList = document.getElementById('userlist');
            userList.innerHTML = '';
            userList.innerHTML += `
            <li style="margin-top: 5px; margin-bottom: 5px;">${data[0].username}&nbsp;&nbsp;&nbsp;<button onclick="getUserData('${data[0].username}')" style="display: inline-block;">Show Data</button></li>
            `;
            data.shift();
            data.forEach((elem) => {
                userList.innerHTML += `
                <li style="margin-top: 5px; margin-bottom: 5px;">${elem.username}&nbsp;&nbsp;&nbsp;<button onclick="getUserData('${elem.username}')" style="display: inline-block;">Show Data</button>&nbsp;&nbsp;<button onclick="whisper('${elem.username}')" style="display: inline-block;">Whisper</button></li>
                `;
            });
        });

        socket.on('lobby:resUserData', (data) => {
            var userData = document.getElementById('userdata');
            userData.innerHTML = `
                <p>User name : ${data.username}</p>
                <p>User email : ${data.email}</p>
                <p>Win : ${data.win}</p>
                <p>Loss : ${data.loss}</p>
                <p>Draw : ${data.draw}</p>
                <p>Last Login : ${data.last_connection}</p>
            `;
            if (data.username != inputname) {
                userData.innerHTML += `<button onclick="whisper('${data.username}')">Whisper</button>`;
            }
        });

        socket.on('lobby:invite', (username, roomname) => {
            modal.style.display = "block";
            var userData = document.getElementById('userdata');
            userData.innerHTML = `
                <p>User name : ${username}</p>
                <p>Invited you to </p>
                <button><a href="/game/${roomname}">Accept Invite</a></button>
                <button onclick="closeModal()">Cancel</button>
            `;
        });


        chatForm.onsubmit = (e) => {
            e.preventDefault();
            var chatInput = document.getElementById('chatInput');

            // socket.emit으로 서버에 신호를 전달
            socket.emit('lobby:sendChat', chatInput.value);

            chatInput.value = "";
        };
    </script>
</body>

</html>